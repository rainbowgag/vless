sudo bash -c 'set -euo pipefail
apt update -y
apt install -y curl unzip jq

# 安装/更新 Xray（官方安装器）
bash <(curl -fsSL https://raw.githubusercontent.com/XTLS/Xray-install/main/install-release.sh) install

# 让用户输入节点名称
read -p "请输入节点名称(备注)： " NODENAME
NODENAME=${NODENAME:-VLESS-TCP}  # 如果不输入，就默认 VLESS-TCP

UUID=$(cat /proc/sys/kernel/random/uuid)
PORT=$(shuf -i 20000-65000 -n1)

# 生成配置（VLESS TCP, 无 TLS）
install -d /usr/local/etc/xray
cat >/usr/local/etc/xray/config.json <<EOF
{
  "log": { "access": "/var/log/xray/access.log", "error": "/var/log/xray/error.log", "loglevel": "warning" },
  "inbounds": [
    {
      "port": $PORT,
      "protocol": "vless",
      "settings": {
        "clients": [{ "id": "$UUID" }],
        "decryption": "none"
      },
      "sniffing": { "enabled": true, "destOverride": ["http", "tls"] },
      "streamSettings": { "network": "tcp" },
      "listen": "0.0.0.0",
      "tag": "vless-in"
    }
  ],
  "outbounds": [
    { "protocol": "freedom", "tag": "direct" },
    { "protocol": "blackhole", "tag": "blocked" }
  ]
}
EOF

# 放行防火墙（如 UFW 已启用）
if command -v ufw >/dev/null 2>&1 && ufw status 2>/dev/null | grep -q "Status: active"; then
  ufw allow ${PORT}/tcp || true
fi

# 启动并自启动
systemctl enable xray >/dev/null 2>&1
systemctl restart xray

# 获取公网 IP
IPV4=$(curl -4 -fsS https://api.ipify.org || true)
IPV6=$(curl -6 -fsS https://api64.ipify.org || true)
IP=${IPV4:-$IPV6}

LINK="vless://${UUID}@${IP}:${PORT}?encryption=none&security=none&type=tcp#${NODENAME}"
echo
echo "================ VLESS 链接 ================"
echo "$LINK"
echo "==========================================="
echo "配置文件：/usr/local/etc/xray/config.json"
echo "日志：/var/log/xray/{access.log,error.log}"

# 添加 vlesslink 命令，方便下次直接查看链接
cat >/usr/local/bin/vlesslink <<EOFA
#!/bin/bash
UUID=\$(jq -r ".inbounds[0].settings.clients[0].id" /usr/local/etc/xray/config.json)
PORT=\$(jq -r ".inbounds[0].port" /usr/local/etc/xray/config.json)
IP=\$(curl -s ipv4.ip.sb || curl -s ipv6.ip.sb)
NAME="$NODENAME"
echo "vless://\${UUID}@\${IP}:\${PORT}?encryption=none&security=none&type=tcp#\${NAME}"
EOFA

chmod +x /usr/local/bin/vlesslink
'
